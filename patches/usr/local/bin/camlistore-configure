#!/bin/bash

if test "$#" -ne 2; then
    echo "usage: camlistore-configure username password # credentials to access Camlistore's web UI"
	exit 1
fi

confFile="/home/camli/.config/camlistore/server-config.json"

if test ! -f "$confFile"; then
	# starting camlistored so it generates a default config file for us.
	su -c '/usr/local/bin/camlistored -openbrowser=false' camli &
	# TODO(mpl): make a flag for camlistored to just gen the config file and quit.
	for i in `seq 30`
	do
		if test -f "$confFile"; then
			pkill camlistored
			break
		fi
		if test "$i" == "30"; then
			echo 'waited too long for camlistored to generate a config file'
			pkill camlistored
			exit 1
		fi
		sleep 1
	done
fi

sed -i -e 's#"auth":\ "localhost",#"auth": "userpass:'$1:$2'",#' $confFile
sed -i -e 's#"kvIndexFile":\ "/home/camli/var/camlistore/camli-index.kvdb",#"mysql": "root@localhost:3306:",#' $confFile
sed -i -e 's#"dbNames":\ null#"dbNames": {\n\t\t"queue-sync-to-index": "sync_index_queue",\n\t\t"ui_thumbcache": "ui_thumbmeta_cache",\n\t\t"blobpacked_index": "blobpacked_index"\n\t},\n\t"https": true,\n\t"packRelated": true#' $confFile

systemctl stop mysql
systemctl disable mysql
systemctl enable camli-mysql
systemctl enable camlistored
systemctl restart camli-mysql
systemctl restart camlistored

exit 0
